---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="flex flex-col min-h-screen">

    <!-- Connect screen -->
    <div id="connect-screen" class="flex-1 flex items-center justify-center">
      <div class="text-center">
        <h1 class="text-3xl font-bold mb-2 tracking-tight" style="color: var(--text-primary);">
          NDEXPLORER
        </h1>
        <p class="text-sm mb-6" style="color: var(--text-muted);" data-i18n="app.subtitle">
          NextDNS Log Explorer
        </p>

        <div class="flex items-center justify-center gap-3 mb-8">
          <button data-lang="pl" class="text-2xl leading-none px-1.5 py-1 rounded cursor-pointer transition-opacity duration-150" style="border: 2px solid var(--accent);" title="Polski">ðŸ‡µðŸ‡±</button>
          <button data-lang="en" class="text-2xl leading-none px-1.5 py-1 rounded cursor-pointer transition-opacity duration-150" style="border: 2px solid transparent; opacity: 0.5;" title="English">ðŸ‡¬ðŸ‡§</button>
        </div>

        <button
          id="connect-btn"
          class="px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer flex items-center gap-2 mx-auto"
          style="background-color: var(--accent); color: white;"
        >
          <span id="connect-btn-text" data-i18n="connect.button">Connect to NextDNS</span>
          <span id="connect-btn-spinner" class="spinner spinner-sm" style="border-color: rgba(255,255,255,0.3); border-top-color: white; display: none;"></span>
        </button>

        <div class="mt-10 text-xs" style="color: var(--text-muted);">
          NDExplorer &middot;
          <a href="https://github.com/maciejaszex/ndexplorer" target="_blank" rel="noopener noreferrer" class="underline hover:no-underline" style="color: var(--text-secondary);">github.com/maciejaszex/ndexplorer</a>
        </div>
      </div>
    </div>

    <!-- Main panel (hidden until connected) -->
    <div id="main-panel" class="flex flex-col" style="display: none;">

      <!-- Header -->
      <header class="px-4 py-3 flex items-center justify-between mobile-header" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border);">
        <div class="flex items-center gap-3">
          <h1 class="text-sm font-bold tracking-tight" style="color: var(--text-primary);">NDEXPLORER</h1>
          <a href="https://github.com/maciejaszex/ndexplorer" target="_blank" rel="noopener noreferrer" class="flex items-center opacity-50 hover:opacity-100 transition-opacity duration-150" title="GitHub">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="color: var(--text-secondary);">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
          </a>
          <span class="text-xs px-2 py-0.5 rounded" style="background-color: var(--bg-tertiary); color: var(--text-muted);" data-i18n="header.readonly">READ-ONLY</span>
        </div>
        <div class="flex items-center gap-3 mobile-header-right">
          <div id="log-counter" class="text-xs" style="color: var(--text-muted); display: none;">
            <span data-i18n="header.displayed">Displayed:</span> <span id="log-count">0</span> <span data-i18n="header.logs">logs</span>
          </div>
          <div class="flex items-center gap-1">
            <button data-lang="pl" class="text-sm leading-none px-0.5 py-0.5 rounded cursor-pointer transition-opacity duration-150" style="border: 2px solid var(--accent);" title="Polski">ðŸ‡µðŸ‡±</button>
            <button data-lang="en" class="text-sm leading-none px-0.5 py-0.5 rounded cursor-pointer transition-opacity duration-150" style="border: 2px solid transparent; opacity: 0.5;" title="English">ðŸ‡¬ðŸ‡§</button>
          </div>
        </div>
      </header>

      <!-- API filters -->
      <div class="px-4 py-3" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border);">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-medium" style="color: var(--text-muted);" data-i18n="filters.api">API Filters:</span>
        </div>
        <form id="filter-form" class="flex flex-wrap items-end gap-3 mobile-filters">

          <div class="flex flex-col gap-1">
            <label for="filter-from" class="text-xs" style="color: var(--text-muted);" data-i18n="filters.from">From</label>
            <input type="datetime-local" id="filter-from" class="px-2 py-1.5 rounded text-xs font-mono" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);" />
          </div>

          <div class="flex flex-col gap-1">
            <label for="filter-to" class="text-xs" style="color: var(--text-muted);" data-i18n="filters.to">To</label>
            <input type="datetime-local" id="filter-to" class="px-2 py-1.5 rounded text-xs font-mono" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);" />
          </div>

          <div class="flex flex-col gap-1">
            <span class="text-xs" style="color: var(--text-muted);" data-i18n="filters.range">Range</span>
            <div class="flex gap-1">
              <button type="button" data-range="15m" class="date-range-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" data-i18n="filters.range.15m">15m</button>
              <button type="button" data-range="1h" class="date-range-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" data-i18n="filters.range.1h">1h</button>
              <button type="button" data-range="24h" class="date-range-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" data-i18n="filters.range.24h">24h</button>
              <button type="button" data-range="72h" class="date-range-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" data-i18n="filters.range.72h">72h</button>
            </div>
          </div>

          <div class="flex flex-col gap-1">
            <label for="filter-status" class="text-xs" style="color: var(--text-muted);" data-i18n="filters.status">Status</label>
            <select id="filter-status" class="px-2 py-1.5 rounded text-xs" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);">
              <option value="" data-i18n="filters.all">All</option>
              <option value="default">default</option>
              <option value="blocked">blocked</option>
              <option value="allowed">allowed</option>
              <option value="error">error</option>
            </select>
          </div>

          <div class="flex flex-col gap-1">
            <label for="filter-device" class="text-xs" style="color: var(--text-muted);" data-i18n="filters.device">Device</label>
            <select id="filter-device" class="px-2 py-1.5 rounded text-xs" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);">
              <option value="" data-i18n="filters.all">All</option>
            </select>
          </div>

          <button type="submit" id="search-btn" class="px-4 py-1.5 rounded text-xs font-medium transition-all duration-200 cursor-pointer flex items-center gap-2" style="background-color: var(--accent); color: white;">
            <span id="search-btn-text" data-i18n="filters.search">Search</span>
            <span id="search-btn-spinner" class="spinner spinner-sm" style="border-color: rgba(255,255,255,0.3); border-top-color: white; display: none;"></span>
          </button>

          <div class="mx-1 self-stretch mobile-filter-separator" style="width: 1px; background-color: var(--border);"></div>

          <!-- Auto-refresh -->
          <div class="flex flex-col gap-1 relative">
            <span class="text-xs" style="color: var(--text-muted);" data-i18n="autorefresh.label">Auto-refresh</span>

            <div class="flex gap-1 items-center">
              <button type="button" data-refresh="30" class="auto-refresh-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150 font-mono disabled:opacity-40 disabled:cursor-not-allowed" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" disabled>
                <span class="ar-label">30s</span>
              </button>
              <button type="button" data-refresh="60" class="auto-refresh-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150 font-mono disabled:opacity-40 disabled:cursor-not-allowed" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" disabled>
                <span class="ar-label">1m</span>
              </button>
              <button type="button" data-refresh="300" class="auto-refresh-btn px-2 py-1.5 rounded text-xs cursor-pointer transition-colors duration-150 font-mono disabled:opacity-40 disabled:cursor-not-allowed" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" disabled>
                <span class="ar-label">5m</span>
              </button>
            </div>
            <div id="ar-preset-hint" class="absolute left-0 -top-7 px-2 py-1 rounded text-xs whitespace-nowrap" style="background-color: var(--bg-tertiary); color: var(--status-error); border: 1px solid var(--border); display: none;" data-i18n="autorefresh.hint">
              Auto-refresh requires the "15m" or "1h" preset
            </div>
          </div>
        </form>
      </div>

      <!-- Local filters -->
      <div class="px-4 py-2 flex items-center gap-5 mobile-local-filters" style="background-color: var(--bg-primary); border-bottom: 1px solid var(--border);">
        <span class="text-xs font-medium" style="color: var(--text-muted);" data-i18n="filters.local">Local Filters:</span>

        <div class="flex items-center gap-1.5 mobile-local-filter-item">
          <label for="local-filter-domain" class="text-xs whitespace-nowrap" style="color: var(--text-secondary);" data-i18n="filters.domain">Domain</label>
          <div class="relative">
            <input type="text" id="local-filter-domain" class="px-2 py-1 pr-6 rounded text-xs font-mono w-40" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);" data-i18n-placeholder="filters.domainPlaceholder" placeholder="e.g. facebook" />
            <button type="button" class="input-clear-btn" data-clear="local-filter-domain" aria-label="Clear">&times;</button>
          </div>
        </div>

        <div class="flex items-center gap-1.5 mobile-local-filter-item">
          <label for="local-filter-tracker-search" class="text-xs whitespace-nowrap" style="color: var(--text-secondary);" data-i18n="filters.tracker">Tracker</label>
          <div class="relative">
            <input type="text" id="local-filter-tracker-search" class="px-2 py-1 pr-6 rounded text-xs font-mono w-40" style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);" data-i18n-placeholder="filters.trackerPlaceholder" placeholder="e.g. google" />
            <button type="button" class="input-clear-btn" data-clear="local-filter-tracker-search" aria-label="Clear">&times;</button>
          </div>
        </div>

        <label class="flex items-center gap-2.5 cursor-pointer select-none">
          <span class="text-xs" style="color: var(--text-secondary);" data-i18n="filters.showTrackers">Show trackers</span>
          <div class="relative inline-flex items-center">
            <input type="checkbox" id="local-filter-tracker" class="sr-only peer" checked />
            <div class="w-10 h-5 rounded-full transition-colors duration-200" style="background-color: var(--bg-tertiary); border: 1px solid var(--border);"></div>
            <div class="absolute left-0.5 w-4 h-4 rounded-full transition-transform duration-200" style="background-color: var(--text-muted);" id="tracker-toggle-dot"></div>
          </div>
        </label>
      </div>

      <!-- Log table (header + rows scroll together on mobile) -->
      <div class="mobile-log-scroll">
        <div class="mobile-log-inner">
          <!-- Log list headers -->
          <div class="px-4 py-2 grid gap-2 text-xs font-medium" style="background-color: var(--bg-tertiary); color: var(--text-muted); grid-template-columns: 140px minmax(0, 2fr) minmax(0, 1.5fr) minmax(0, 1.5fr) 90px 80px minmax(0, 1fr);">
            <span data-i18n="logs.date">Date</span>
            <span data-i18n="logs.domain">Domain</span>
            <span data-i18n="logs.root">Root</span>
            <span data-i18n="logs.tracker">Tracker</span>
            <span data-i18n="logs.protocol">Protocol</span>
            <span data-i18n="logs.status">Status</span>
            <span data-i18n="logs.device">Device</span>
          </div>

          <!-- Log list -->
          <div id="logs-area">
            <div id="logs-empty" class="flex items-center justify-center py-20">
              <p class="text-sm" style="color: var(--text-muted);" data-i18n="logs.empty">Set filters and click "Search"</p>
            </div>
            <div id="logs-loading" class="flex items-center justify-center py-20" style="display: none;">
              <div class="spinner spinner-lg"></div>
            </div>
            <div id="logs-no-results" class="flex items-center justify-center py-20" style="display: none;">
              <p class="text-sm" style="color: var(--text-muted);" data-i18n="logs.noResults">No logs for selected filters</p>
            </div>
            <div id="logs-list"></div>
            <div id="logs-scroll-loader" class="flex items-center justify-center py-4" style="display: none;">
              <div class="spinner"></div>
            </div>
            <div id="logs-end" class="flex items-center justify-center py-4" style="display: none;">
              <p class="text-xs" style="color: var(--text-muted);" data-i18n="logs.allLoaded">All logs loaded</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</Layout>
